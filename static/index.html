<html>
<head>
  <script type="text/javascript" src="//code.jquery.com/jquery-2.0.3.min.js"></script>
  <script type="text/javascript" src="/js/purl.js"></script>
</head>
<body>
<div id='data-upload-ftw-gangnam-style-bbqsauce' style='display:none'>
  <h1>Upload new data. All previous data will be deleted.</h1>

  <input type="text" name="animas_bg_selected" id='animas_bg_selected' style='display:none'/>
  <input type="text" name="animas_pump_selected" id='animas_pump_selected' style='display:none'/>
  <input type="text" name="dexcom_selected" id='dexcom_selected' style='display:none'/>
  <input type="text" name="medtronic_selected" id='medtronic_selected' style='display:none'/>

  <form enctype="multipart/form-data" id='bbqsauce_upload_form'>
    <ul>
      <li id='upload-animas'>
        <h2>Diasend</h2>

        <div class='device-import' style='display:none'>
          <h3>Please enter your Diasend credentials.</h3>

          <p>We need them to fetch your data. We will ask you this every time. We <b>will not</b> store your Diasend
            username or password.</p>
          <br>
          <h5>Username:</h5>
          <input id="diasendUsername" type="text" name="diasendUsername" placeholder='Username'>
          <h5>Password:</h5>
          <input id="diasendPassword" type="password" name="diasendPassword" placeholder='Password'>
        </div>
      </li>
      <li id='upload-dexcom'>
        <h2>Dexcom</h2>

        <div class='device-import' style='display:none'>
          <h3>Export your data from Dexcom Studio as a tab-delimited file and upload it here.</h3>

          <p>If you need help with getting your data into Dexcom Studio <a
            href='http://www.dexcom.com/faq/dexcom-studio/getting-started' target='_blank'>go here</a>.</p>

          <input type="file" name="dexcom" id='dexcom' />
        </div>
      </li>
      <li id='upload-medtronic'>
        <h2>Carelink</h2>

        <div class='device-import' style='display:none'>
          <h3>Please enter your Carelink credentials.</h3>

          <p>We need them to fetch your data. We will ask you this every time. We <b>will not</b> store your Carelink
            username or password.</p>
          <br>
          <h5>Username:</h5>
          <input id="carelinkUsername" type="text" name="carelinkUsername" placeholder='Carelink Username'>
          <h5>Password:</h5>
          <input id="carelinkPassword" type="password" name="carelinkPassword" placeholder='Carelink Password'>
        </div>
      </li>
    </ul>
  </form>
  <input type="submit" id="uploadButton" value="submit">
</div>
<script>
  var isFilledIn = function () {
    var somethingFilledIn = false;
    somethingFilledIn = ($('#carelinkUsername').val() && $('#carelinkPassword').val()) || somethingFilledIn;
    somethingFilledIn = ($('#diasendUsername').val() && $('#diasendPassword').val()) || somethingFilledIn;
    return somethingFilledIn;
  }

  this.dexcomFileName = '';
  this.dexcomFileUrl = '';


  function render(groupId) {
    var self = this;
    self.groupId = groupId;

    var el = $('#data-upload-ftw-gangnam-style-bbqsauce')
    el.show();
    el.find('.go').addClass('disabled');
    el.find('#profile-setup-device-picker').fadeIn();
    el.find('#upload-animas h2').click(self.animas);
    el.find('#upload-medtronic h2').click(self.medtronic);
    el.find('#upload-dexcom h2').click(self.dexcom);
    el.find('input').on('change keydown paste input', self.ready);

    el.find('#uploadButton').click(function (e) {
      if (e) {
        e.preventDefault();
      }

      if (!isFilledIn()) {
        return;
      }

      var token = $.url().param('token');
      var formData = new FormData($('#bbqsauce_upload_form')[0]);
      formData.append("timezoneOffset", "0");
      formData.append("daysAgo", 180);
      $.ajax(
        {
          url: '/v1/device/upload?&timezone=0',
          type: 'POST',
          headers: {
            'x-tidepool-session-token': token
          },
          xhr: function() {
            var myXhr = $.ajaxSettings.xhr();
            return myXhr;
          },
          beforeSend: function(){},
          success: function(syncTask) {
            console.info('Upload data succeded', syncTask);

            var syncTaskId = syncTask._id;

            // Polling frequency, in milliseconds
            var pollingInterval = 3 * 1000;

            // When to give up, in milliseconds
            var pollingTimeout = 5 * 60 * 1000;
            var pollingTimedOut = false;

            setTimeout(function () {
              pollingTimedOut = true;
            }, pollingTimeout);

            // Start long-polling sync task status
            (function poll(done) {
              setTimeout(function () {
                $.ajax(
                  {
                    url: '/v1/synctasks/'+ syncTaskId + '?token=' + token,
                    type: 'GET',
                    headers: {
                      'x-tidepool-session-token': token
                    },
                    xhr: function() {
                      var myXhr = $.ajaxSettings.xhr();
                      return myXhr;
                    },
                    beforeSend: function(){},
                    success: function(status) {
                      console.log('poll complete, status is', status);
                      if (status.status === 'success') {
                        return done(null, status);
                      }
                      poll(done);
                    },
                    error: function(err){
                      console.log('Error!!!!', err);
                    },
                    cache: false,
                    contentType: false,
                    processData: false
                  }
                );
              }, pollingInterval);
            }(onSyncTaskFinished));

            function onSyncTaskFinished(err, syncTask) {
              if (err) {
                alert(err.toString());
                return;
              }
              alert('Data upload complete!');
            }
          },
          error: function(err){
            console.log('Error!!!!', err);
          },
          data: formData,
          cache: false,
          contentType: false,
          processData: false
        }
      );


/*
      var uploadData = self.getUploadData();

      // Create new sync task
      app.api.group.postDeviceData(groupId, uploadData, function (error, syncTask) {
      });
 */
    });
  }

  function animas() {
    $('#upload-animas .device-import').slideToggle();
  }

  function dexcom() {
    $('#upload-dexcom .device-import').slideToggle();
  }

  function medtronic() {
    $('#upload-medtronic .device-import').slideToggle();
  }

  render();
</script>
</body>